<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valuation Report Generator Section 6</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        #previewContainer img,
        #glPreviewContainer img {
            max-width: 100%; /* Responsive image */
            height: auto; /* Maintain aspect ratio */
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Valuation Report Generator Section 6</h1>
        <form id="valuationForm">          
            <div class="form-group">
                <label>Upload Image of Google Map of Land<span class="required">*</span></label>
                <input type="file" id="googleMap" accept="image/*" required>
                <div>
                    <label for="googleMapWidth">Width (px):</label>
                    <input type="number" id="googleMapWidth" placeholder="Suggested: 100" value="100">
                    <label for="googleMapHeight">Height (px):</label>
                    <input type="number" id="googleMapHeight" placeholder="Suggested: 100" value="60">
                </div>
                <div id="previewContainer"></div>
            </div>
            
            <div class="form-group">
                <label>GUIDELINE RATE<span class="required">*</span></label>
                <input type="file" id="glImage" accept="image/*" required>
                <div>
                    <label for="glImageWidth">Width (px):</label>
                    <input type="number" id="glImageWidth" placeholder="Suggested: 300" value="300">
                    <label for="glImageHeight">Height (px):</label>
                    <input type="number" id="glImageHeight" placeholder="Suggested: 200" value="200">
                </div>
                <div id="glPreviewContainer"></div>
            </div>
            <button type="button" onclick="prevSection(4)">Previous</button>
            <button id="generatePdfBtn" type="submit">Generate Pdf</button>
        </form>
    </div>

    <script>
        // Function to preview the uploaded image and store its data
        function previewImage(input, previewContainerId, widthInputId, heightInputId, storageKey) {
            const file = input.files[0];
            const previewContainer = document.getElementById(previewContainerId);
            const widthInput = document.getElementById(widthInputId);
            const heightInput = document.getElementById(heightInputId);

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Show image preview
                    previewContainer.innerHTML = `<img src="${e.target.result}" alt="Image Preview" style="width: ${widthInput.value}px; height: ${heightInput.value}px;">`;

                    // Store image data and dimensions in localStorage
                    const imageData = {
                        src: e.target.result,
                        width: parseInt(widthInput.value),
                        height: parseInt(heightInput.value)
                    };
                    localStorage.setItem(storageKey, JSON.stringify(imageData));
                };
                reader.readAsDataURL(file);
            } else {
                previewContainer.innerHTML = '';
            }
        }

// Event listeners for image uploads
document.getElementById('googleMap').addEventListener('change', function() {
    previewImage(this, 'previewContainer', 'googleMapWidth', 'googleMapHeight', 'googleMapData');
});

document.getElementById('glImage').addEventListener('change', function() {
    previewImage(this, 'glPreviewContainer', 'glImageWidth', 'glImageHeight', 'glImageData');
});
        // Function to validate and store data
        document.getElementById('valuationForm').addEventListener('submit', function (e) {
            e.preventDefault();

            // Validate all required fields
            const requiredFields = this.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value) {
                    isValid = false;
                    field.style.borderColor = 'red';
                } else {
                    field.style.borderColor = '#ddd';
                }
            });

            if (!isValid) {
                alert('Please fill in all required fields');
                return;
            }

            const Container_6 = {                
                googleMap: document.getElementById('googleMap').value,
                glImage: document.getElementById('glImage').value,                
            };

            localStorage.setItem('Container_6', JSON.stringify(Container_6));
            console.log("Captured Data:", Container_6);
        });

      // PDF generation
document.getElementById("generatePdfBtn").addEventListener("click", async function () {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    try {
        // Load and parse data for each container from localStorage
        const Container_1 = JSON.parse(localStorage.getItem('Container_1'));
        const Container_2 = JSON.parse(localStorage.getItem('Container_2'));
        const Container_3 = JSON.parse(localStorage.getItem('Container_3'));
        const Container_4 = JSON.parse(localStorage.getItem('Container_4'));
        const Container_5 = JSON.parse(localStorage.getItem('Container_5'));
        const Container_6 = JSON.parse(localStorage.getItem('Container_6'));

        console.log("Loaded Data:", { Container_1, Container_2, Container_3, Container_4, Container_5, Container_6 });

        // Ensure each container function runs sequentially and starts at the correct position
        await Container1(doc, Container_1);
        doc.addPage();  // Add new page after each section

        await Container2(doc, Container_2);
        doc.addPage();

        await Container3(doc, Container_3);
        doc.addPage();

        await Container4(doc, Container_4);
        doc.addPage();

        await Container5(doc, Container_5);
        doc.addPage();

        await Container6(doc, Container_6);

        // Add footer on the last page
        addFooter(doc);

        // Save the PDF as a single file
        doc.save("Full_Report.pdf");

    } catch (error) {
        console.error("Error generating PDF:", error);
    }
});


        function addFooter(doc) {
            const leftMargin = 25.7;  
            const rightMargin = 17.5; 
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            
            // Add horizontal line at the bottom
            const footerY = pageHeight - 28.7;
            doc.setLineWidth(0.1);
            doc.setFont('helvetica', 'bold');
            // Page number on right
            doc.text('Page 6', pageWidth - rightMargin - 55, footerY);
            doc.text('Ref No.', pageWidth - rightMargin - 55, footerY + 4);
            // Reference number 
            doc.text('TP/JCB/K-BKR/R-09/12/2024-25', pageWidth - rightMargin - 55, footerY + 8);
        }

    </script>

    <script src="page_6.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

</body>

</html>